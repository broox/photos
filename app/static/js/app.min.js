function buildQueryString(t){const e=encodeURIComponent;return Object.keys(t).map(s=>e(s)+"="+e(t[s])).join("&")}function getBrowserWidth(){return Math.max(document.body.scrollWidth,document.documentElement.scrollWidth,document.body.offsetWidth,document.documentElement.offsetWidth,document.documentElement.clientWidth)}function getBrowserHeight(){return Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.documentElement.clientHeight)}function isLargeViewport(){return getBrowserWidth()>500}function pluralize(t,e){return 1==t?e:e+"s"}function serializeForPhotoSwipe(t){const e=isLargeViewport()?t.images.medium:t.images.small;let s=t.images.medium;t.images.large&&(s=t.images.large);const o=t.tags;let i=t.description;if(o){i+="<br>";for(let t=0;t<o.length;t++)i+=' <a href="/tagged/'+o[t].slug+'">#'+o[t].name.replace(/\s/g,"")+"</a>"}return{id:t.id,src:s,w:t.width,h:t.height,msrc:e,title:i,thumbnail:e}}const photosMixin={data:{album:null,albums:[],cachedPhotos:[],cachedPhotoAmount:0,fullSearch:!1,limit:40,loading:!1,photos:[],offset:0,pageText:null,photoRowHeight:200,searchInput:null,searchTerm:null,tag:null,title:null,totalPhotoCount:0},created(){isLargeViewport()&&(this.photoRowHeight=300)},computed:{showRealtimeSearchResults(){return this.albums.length>0&&!this.album&&!this.tag},photoCountDisplay(){const t=this.totalPhotoCount;if(t)return t.toLocaleString()+" "+pluralize(t,"photo")}},methods:{addPhotosToGallery(t){const e=t.map(serializeForPhotoSwipe);this.photos.push(...e)},clearAlbum(){return this.album=null,this.resetPage(),this.loadPhotos()},clearGallery(){this.title=null,this.album?this.clearAlbum():this.tag&&this.clearTag()},clearRealtimeSearchResults(t){this.albums=[]},clearSearch(){this.searchTerm=null},clearSearchForm(){return this.searchInput=null,this.clearRealtimeSearchResults(),this.clearSearch(),this.resetPage(),this.loadPhotos()},clearTag(){return this.tag=null,this.resetPage(),this.loadPhotos()},fetchPhotos(){this.message="Loading...",this.loading=!0;const t={limit:this.limit,offset:this.offset},e={};this.album&&(e.album_id=this.album.id),this.searchTerm&&(e.search=this.searchTerm),this.tag&&(e.tag=this.tag);let s=!1;if(!Object.keys(e).length&&0==this.offset){if(this.cachedPhotos.length)return this.message=null,this.loading=!1,this.photos=this.cachedPhotos,this.totalPhotoCount=this.cachedPhotoAmount,new Promise((t,e)=>{t()});s=!0}return fetch("/api/v1/photos?"+buildQueryString(Object.assign(t,e))).then(t=>t.json()).then(t=>{const e=t.data;this.totalPhotoCount=t.meta.count,this.addPhotosToGallery(e),this.message=null,this.loading=!1,s&&(this.cachedPhotoAmount=this.totalPhotoCount,this.cachedPhotos=this.photos.slice(0,40))}).catch(t=>{this.message="Error loading photos",this.loading=!1,console.error("Error fetching photos")})},loadPhotos(){return this.updateGalleryURL(),this.fetchPhotos().then(()=>{this.renderGallery(),this.setupSlideShow()})},loadMorePhotos(){if(this.offset=this.offset+this.limit,!(this.offset>=this.totalPhotoCount))return this.loadPhotos()},realtimeSearch(t){this.lastSearchTerm!=this.searchInput&&(this.searchInput.length>2&&"Enter"!==t.key?(this.searchAlbums(this.searchInput),this.lastSearchTerm=this.searchInput):(this.clearRealtimeSearchResults(),this.lastSearchTerm=null))},renderGallery(){new flexImages({selector:".flex-images",rowHeight:this.photoRowHeight}),this.offset<this.totalPhotoCount&&window.addEventListener("scroll",this.infiniteScroll)},resetPage(){this.pageText=null,this.photos=[],this.offset=0,this.totalPhotoCount=0,window.scrollTo(0,0)},searchAlbums(t){this.message="Loading...",this.loading=!0;const e=t;return fetch("/api/v1/albums?"+buildQueryString({limit:15,search:t})).then(t=>t.json()).then(s=>{if(this.fullSearch||e!==t)return;const o=s.data;this.albums=o,this.message=null,this.loading=!1}).catch(t=>{this.message="Error loading albums",this.loading=!1,console.error("Error fetching albums")})},searchPhotos(){this.clearRealtimeSearchResults(),this.resetPage(),this.searchTerm=this.searchInput,this.fullSearch=!0,this.loadPhotos().then(()=>{this.fullSearch=!1})},selectAlbum(t){return this.album=t,this.title=t.title,this.clearSearch(),this.resetPage(),this.album.description&&(this.pageText=this.album.description),this.loadPhotos()},selectTag(t){return this.tag=t,this.title=t,this.clearSearch(),this.resetPage(),this.loadPhotos()},setupSlideShow(){const t=document.querySelectorAll(".item");for(let e=t.length;e--;)t[e].onclick=this.openSlideShow},syncSearchForm(){this.searchInput!==this.searchTerm&&(this.searchInput=this.searchTerm)},updateGalleryURL(){let t=window.location.origin,e="Broox Photos";if(this.album)t+="/"+this.album.slug,e=this.album.title;else if(this.searchTerm){const s=encodeURIComponent(this.searchTerm);t+="/search/"+s,e=s}else this.tag&&(t+="/tagged/"+this.tag,e=this.tag);document.title=e,document.location!==t&&window.history.replaceState({id:e},e,t)},openSlideShow(t){t.preventDefault();const e=document.querySelectorAll(".pswp")[0],s={index:parseInt(t.currentTarget.dataset.index,10),getThumbBoundsFn:function(t){var e=document.querySelectorAll(".item img")[t],s=window.pageYOffset||document.documentElement.scrollTop,o=e.getBoundingClientRect();return{x:o.left,y:o.top+s,w:o.width}},shareButtons:[{id:"download",label:"Download image",url:"{{raw_image_url}}",download:!0}]};isNaN(s.index)||new PhotoSwipe(e,PhotoSwipeUI_Default,this.photos,s).init()},infiniteScroll(){const t=document.documentElement.offsetHeight;document.documentElement.scrollTop+window.innerHeight+10*this.photoRowHeight>=t&&(this.loadMorePhotos(),window.removeEventListener("scroll",this.infiniteScroll))}}},app=new Vue({el:"#app",data:{message:null},mixins:[photosMixin]}),header=document.getElementById("pageHeader"),sticky=header.offsetTop;window.onscroll=()=>{window.pageYOffset>sticky?header.classList.add("sticky"):header.classList.remove("sticky")},document.onkeydown=t=>{"Escape"===t.key&&app.clearRealtimeSearchResults()};